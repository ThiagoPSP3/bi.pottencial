<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pottenccial BI Hub</title>
    <style>
      :root {
        --brand-orange: #f27020;
        --brand-dark: #c15a18;
        --background: #f5f5f5;
        --text-dark: #4d4d4d;
        --text-light: #ffffff;
        --card-radius: 18px;
      }

      * {
        box-sizing: border-box;
        font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        background: var(--background);
        color: var(--text-dark);
        overflow: hidden;
      }

      .app-shell {
        display: grid;
        grid-template-columns: 4% 1fr;
        height: 100%;
        min-height: 0;
      }

      nav {
        background: linear-gradient(180deg, var(--brand-orange), var(--brand-dark));
        color: var(--text-light);
        padding: 10px 10px;
        display: flex;
        flex-direction: column;
        gap: 1%;
      }

      .logo {
        display: flex;
        justify-content: center;
        padding: 0;
        margin: 0 -12px;
      }

      .logo-link {
        display: flex;
        width: 100%;
        justify-content: center;
        padding: 0px 0px;
        border-radius: 0 0 1% 1%;
        transition: background 0.2s ease;
      }

      .logo-link:hover {
        background: rgba(255, 255, 255, 0.18);
      }

      .logo img {
        width: 100%;
        height: auto;
        display: block;
        max-width: 90%;
      }

      .nav-items {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow: hidden;
        padding-right: 0px;
      }

      .nav-button {
        border: 0;
        border-radius: 10px;
        padding: 12px 10px;
        background: rgba(255, 255, 255, 0.12);
        color: inherit;
        cursor: pointer;
        font-weight: 600;
        text-transform: uppercase;
        writing-mode: sideways-lr;
        transition: background 0.2s ease;
      }

      .nav-button:hover,
      .nav-button.active {
        background: #ffffff;
        color: var(--brand-orange);
      }

      .nav-footer {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: auto;
        padding-top: 0px;
      }

      .nav-footer a {
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 20px;
        color: var(--text-light);
        text-decoration: none;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .nav-footer a:hover {
        background: rgba(255, 255, 255, 0.32);
      }

      main {
        padding: 5px 5px;
        display: grid;
        grid-template-rows: 1fr;
        gap: 32px;
        height: 100%;
        overflow: hidden;
        min-height: 0;
      }

      .period-tabs {
        display: flex;
        gap: 24px;
      }

      .pill {
        background: var(--brand-orange);
        color: var(--text-light);
        padding: 24px 24px;
        border-radius: 999px;
        font-weight: 600;
        display: flex;
        gap: 24px;
        align-items: center;
      }

      .pill.secondary {
        background: #ffd9c1;
        color: var(--brand-orange);
      }

      .view {
        display: none;
        animation: fadeIn 0.3s ease forwards;
        overflow: hidden;
        min-height: 0;
      }

      .view.active {
        display: flex;
        flex-direction: column;
        flex: 1 1 auto;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .theme-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        padding: 40px;
        gap: 30px;
        align-content: start;
      }

      .theme-card,
      .panel-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 24px;
        box-shadow: 0 18px 35px -25px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .theme-card:hover,
      .panel-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 32px -22px rgba(0, 0, 0, 0.45);
      }

      .theme-card h3 {
        margin-top: 0;
        color: var(--brand-orange);
      }

      .theme-card p {
        margin-bottom: 0;
        color: #666;
      }

      .theme-submenu {
        list-style: none;
        padding: 0px;
        margin: 18px 0 0;
        display: grid;
        gap: 10px;
      }

      .theme-submenu button {
        border: 1px solid #f0f0f0;
        background: #fafafa;
        border-radius: 12px;
        padding: 10px 14px;
        text-align: left;
        font-weight: 600;
        color: var(--brand-orange);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .theme-submenu button::after {
        content: ">";
        font-size: 16px;
        color: #c7c7c7;
      }

      .theme-submenu button:hover {
        background: #fff2e9;
        transform: translateX(2px);
      }

      .menu-error {
        background: #fff2e9;
        border-radius: var(--card-radius);
        padding: 24px;
        color: var(--brand-dark);
        font-weight: 600;
        box-shadow: 0 18px 35px -25px rgba(0, 0, 0, 0.25);
      }

      .theme-empty {
        margin: 14px 0 0;
        font-size: 13px;
        color: #999;
        font-weight: 500;
      }

      .panel-grid {
        display: grid;
        padding:40px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 30px;
        align-content: start;
      }

      .panel-thumb {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(242, 112, 32, 0.25), rgba(242, 112, 32, 0.55));
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: auto;
        padding-top: 12px;
        color: var(--brand-dark);
        font-weight: 600;
        margin-bottom: 18px;
      }

      .panel-thumb.placeholder {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, rgba(255, 178, 56, 0.25), rgba(157, 116, 27, 0.3));
        border: 1px dashed rgba(242, 112, 32, 0.45);
      }

      .panel-card h4 {
        margin: 0 0 6px;
        color: var(--brand-orange);
      }

      .panel-card p {
        margin: 0;
        font-size: 14px;
        color: #7a7a7a;
      }

      .embed-wrapper {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1 1 auto;
        min-height: 0;
        padding: 0px;
        box-sizing: border-box;
      }

      #view-themes .theme-grid,
      #view-panels .panel-grid,
      #view-embed .embed-wrapper {
        flex: 1 1 auto;
      }

      .embed-wrapper iframe {
        width: 100%;
        height: 100%;
        flex: 1 1 auto;
        border: 0;
        border-radius: 14px;
        box-shadow: 0 12px 28px -18px rgba(0, 0, 0, 0.4);
      }

      .embed-placeholder {
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 16px;
        width: 100%;
        height: 100%;
        border-radius: 14px;
        border: 1px dashed rgba(242, 112, 32, 0.35);
        background: #fff7ec;
        color: var(--brand-orange);
        text-align: center;
        padding: 32px;
        box-shadow: 0 20px 35px -30px rgba(0, 0, 0, 0.35);
      }

      .embed-placeholder.active {
        display: flex;
      }

      .embed-placeholder-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        max-width: 360px;
      }

      .embed-placeholder-card h3 {
        margin: 0;
        font-size: 18px;
        color: var(--brand-orange);
      }

      .embed-placeholder-card p {
        margin: 0;
        font-size: 14px;
        color: #7a4d1c;
      }

      .placeholder-icon {
        width: 48px;
        height: 48px;
        display: inline-block;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23f2c811'/%3E%3Cpath d='M18 46h8V18h-8v28zm12 0h8V24h-8v22zm12 0h8V30h-8v16z' fill='%23232323' opacity='.8'/%3E%3C/svg%3E") center/contain no-repeat;
      }

      .panel-thumb.placeholder .placeholder-icon {
        width: 40px;
        height: 40px;
      }

      .panel-thumb.placeholder .placeholder-label {
        margin-top: 8px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #b86b1b;
      }

      .hidden {
        display: none !important;
      }

      .info-box {
        background: white;
        padding: 18px 22px;
        border-radius: var(--card-radius);
        box-shadow: 0 18px 40px -30px rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .info-box strong {
        color: var(--brand-orange);
      }

      @media (max-width: 960px) {
        .app-shell {
          grid-template-columns: 1fr;
        }

        nav {
          flex-direction: row;
          align-items: center;
          gap: 16px;
          padding: 16px 16px;
          overflow-x: auto;
        }

        .logo {
          flex: 0 0 auto;
          margin: 0;
        }

        .logo-link {
          border-radius: 18px;
        }

        .nav-footer {
          flex: 0 0 auto;
        }

        .nav-items {
          flex-direction: column;
          gap: 12px;
          overflow: visible;
          padding-right: 6px;
        }

        main {
          padding: 10px;
          grid-template-rows: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <nav>
        <div class="logo">
          <a href="#" class="logo-link" data-action="go-home" aria-label="Voltar para o início">
            <img src="logo.png" alt="Pottencial BI Hub" />
          </a>
        </div>
        <div class="nav-items" id="themeNav"></div>
        <div class="nav-footer">
          <a href="#" id="helpMailLink" title="Ajuda">?</a>
        </div>
      </nav>
      <main>
        <section id="view-themes" class="view active">
          <div class="theme-grid" id="themeGrid"></div>
        </section>

        <section id="view-panels" class="view">
          <div class="panel-grid" id="panelGrid"></div>
        </section>

        <section id="view-embed" class="view">
          <div class="embed-wrapper">
            <div class="embed-placeholder" id="embedPlaceholder" role="status" aria-live="polite">
              <div class="embed-placeholder-card">
                <span class="placeholder-icon" aria-hidden="true"></span>
                <h3 id="embedPlaceholderTitle">Power BI em breve</h3>
                <p id="embedPlaceholderMessage">
                  Estamos preparando o link deste painel no Power BI. Tente novamente mais tarde.
                </p>
              </div>
            </div>
            <iframe
              id="powerBIFrame"
              title="Relatório Power BI"
              src=""
              allowfullscreen
            ></iframe>
          </div>
        </section>
      </main>
    </div>

    <script>
      let data = [];

      const themeGrid = document.querySelector("#themeGrid");
      const themeNav = document.querySelector("#themeNav");
      const panelGrid = document.querySelector("#panelGrid");
      const navItemsContainer = document.querySelector(".nav-items");

      const views = {
        themes: document.querySelector("#view-themes"),
        panels: document.querySelector("#view-panels"),
        embed: document.querySelector("#view-embed"),
      };

      const powerBIFrame = document.querySelector("#powerBIFrame");
      const embedPlaceholder = document.querySelector("#embedPlaceholder");
      const embedPlaceholderTitle = document.querySelector("#embedPlaceholderTitle");
      const embedPlaceholderMessage = document.querySelector("#embedPlaceholderMessage");
      const helpMailLink = document.querySelector("#helpMailLink");

      let temaAtual = null;
      let painelAtual = null;
      let viewAtual = "themes";

      function ajustarFonteMenu() {
        if (!navItemsContainer) return;
        const buttons = Array.from(navItemsContainer.querySelectorAll('.nav-button'));
        if (!buttons.length) return;

        buttons.forEach((btn) => {
          btn.style.fontSize = "";
        });

        const isMobile = window.matchMedia("(max-width: 960px)").matches;
        if (isMobile) {
          buttons.forEach((btn) => {
            btn.style.fontSize = "14px";
          });
          return;
        }

        const containerHeight = navItemsContainer.getBoundingClientRect().height;
        if (containerHeight <= 0) {
          buttons.forEach((btn) => {
            btn.style.fontSize = "16px";
          });
          return;
        }

        let low = 12;
        let high = 48;
        let best = low;

        const fits = () => navItemsContainer.scrollHeight <= containerHeight + 0.5;

        while (high - low > 0.5) {
          const mid = (low + high) / 2;
          buttons.forEach((btn) => {
            btn.style.fontSize = `${mid}px`;
          });

          if (fits()) {
            best = mid;
            low = mid;
          } else {
            high = mid;
          }
        }

        const finalSize = Math.max(12, Math.min(40, best));
        buttons.forEach((btn) => {
          btn.style.fontSize = `${finalSize}px`;
        });
      }

      function descricaoPaginaAtual() {
        if (viewAtual === "embed" && temaAtual && painelAtual) {
          return `${temaAtual.nome} > ${painelAtual.titulo}`;
        }
        if (viewAtual === "panels" && temaAtual) {
          return temaAtual.nome;
        }
        return "Início";
      }

      function atualizarLinkAjuda() {
        if (!helpMailLink) return;
        const pagina = descricaoPaginaAtual();
        const subject = encodeURIComponent(`dúvida painel: ${pagina}`);
        helpMailLink.href = `mailto:analytics@pottencial.com.br?subject=${subject}`;
      }

      function slugify(value) {
        return String(value ?? "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");
      }

      function normalizarMenu(itens) {
        if (!Array.isArray(itens)) return [];

        return itens
          .slice()
          .sort((a, b) => (a?.ordem ?? 0) - (b?.ordem ?? 0))
          .map((item, index) => {
            const temaNome = item?.nome ?? `Tema ${index + 1}`;
            const temaSlug = slugify(temaNome) || `tema-${index + 1}`;
            const dashboards = Array.isArray(item?.paineis)
              ? item.paineis
                  .slice()
                  .sort((a, b) => (a?.ordem ?? 0) - (b?.ordem ?? 0))
                  .map((painel, painelIndex) => {
                    const painelNome = painel?.nome ?? `Painel ${painelIndex + 1}`;
                    const painelSlug =
                      slugify(painelNome) || `${temaSlug}-painel-${painelIndex + 1}`;
                    const thumbBase = painel?.thumb ?? painelNome.split(" ").slice(0, 2).join(" ");
                    return {
                      id: painelSlug,
                      titulo: painelNome.toUpperCase(),
                      descricao: painel?.descricao ?? "Descrição em breve.",
                      thumb: thumbBase || "Painel",
                      embedUrl: painel?.embedUrl ?? "",
                    };
                  })
              : [];

            return {
              id: temaSlug,
              nome: temaNome.toUpperCase(),
              descricao: item?.descricao ?? "Descrição em breve.",
              dashboards,
            };
          });
      }

      async function carregarMenu() {
        themeGrid.innerHTML = `<div class="menu-error">Carregando menu...</div>`;
        themeNav.innerHTML = "";

        try {
          const response = await fetch("menu.json", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`Erro ao carregar menu: ${response.status}`);
          }

          const json = await response.json();
          data = normalizarMenu(json);

          if (!data.length) {
            themeGrid.innerHTML = `<div class="menu-error">Nenhum item de menu encontrado.</div>`;
            viewAtual = "themes";
            atualizarLinkAjuda();
            return;
          }

          temaAtual = null;
          painelAtual = null;
          panelGrid.innerHTML = "";
          powerBIFrame.src = "";
          powerBIFrame.classList.remove("hidden");
          embedPlaceholder.classList.remove("active");
          embedPlaceholderTitle.textContent = "Power BI em breve";
          embedPlaceholderMessage.textContent = "Estamos preparando o link deste painel no Power BI. Tente novamente mais tarde.";
          setActiveNav(null);
          renderThemes();
          alternarView("themes");
        } catch (error) {
          console.error(error);
          themeGrid.innerHTML = `<div class="menu-error">Não foi possível carregar o menu. Verifique o arquivo menu.json.</div>`;
          viewAtual = "themes";
          powerBIFrame.classList.remove("hidden");
          embedPlaceholder.classList.remove("active");
          embedPlaceholderTitle.textContent = "Power BI em breve";
          embedPlaceholderMessage.textContent = "Estamos preparando o link deste painel no Power BI. Tente novamente mais tarde.";
          atualizarLinkAjuda();
        }
      }

      function setActiveNav(themeId, panelId) {
        document.querySelectorAll(".nav-button").forEach((btn) => {
          btn.classList.toggle("active", !!themeId && btn.dataset.theme === themeId);
        });
      }

      function renderThemes() {
        themeGrid.innerHTML = "";
        themeNav.innerHTML = "";

        if (!data.length) {
          themeGrid.innerHTML = `<div class="menu-error">Nenhum item de menu encontrado.</div>`;
          return;
        }

        data.forEach((theme) => {
          const card = document.createElement("article");
          card.className = "theme-card";
          const hasDashboards = theme.dashboards.length > 0;
          const subItems = theme.dashboards
            .map(
              (dash) => `
                <li>
                  <button
                    type="button"
                    class="theme-panel-button"
                    data-theme="${theme.id}"
                    data-panel="${dash.id}"
                  >
                    ${dash.titulo}
                  </button>
                </li>
              `,
            )
            .join("");

          const submenuMarkup = hasDashboards
            ? `<ul class="theme-submenu">
              ${subItems}
            </ul>`
            : `<p class="theme-empty">Nenhum painel cadastrado.</p>`;

          card.innerHTML = `
            <h3>${theme.nome}</h3>
            <p>${theme.descricao}</p>
            ${submenuMarkup}
          `;
          card.querySelectorAll(".theme-panel-button").forEach((button) => {
            button.addEventListener("click", (event) => {
              event.stopPropagation();
              const targetTheme = button.dataset.theme;
              const targetPanel = button.dataset.panel;
              if (temaAtual?.id !== targetTheme) {
                selecionarTema(targetTheme);
              }
              selecionarPainel(targetPanel);
            });
          });
          card.addEventListener("click", () => selecionarTema(theme.id));
          themeGrid.appendChild(card);

        const navButton = document.createElement("button");
        navButton.className = "nav-button";
        navButton.textContent = theme.nome;
        navButton.addEventListener("click", () => selecionarTema(theme.id));
        navButton.dataset.theme = theme.id;
        themeNav.appendChild(navButton);
      });

      ajustarFonteMenu();
      }

      function selecionarTema(themeId) {
        const theme = data.find((item) => item.id === themeId);
        if (!theme) return;

        temaAtual = theme;
        painelAtual = null;

        panelGrid.innerHTML = "";
        theme.dashboards.forEach((dash) => {
          const embedUrl = dash.embedUrl && String(dash.embedUrl).trim();
          const hasEmbed = Boolean(embedUrl);
          const thumbMarkup = hasEmbed
            ? `<div class="panel-thumb">${dash.thumb}</div>`
            : `<div class="panel-thumb placeholder" aria-label="Power BI em breve"><span class="placeholder-icon" aria-hidden="true"></span><span class="placeholder-label">Em breve</span></div>`;

          const card = document.createElement("article");
          card.className = "panel-card";
          card.dataset.hasEmbed = hasEmbed;
          card.innerHTML = `
            ${thumbMarkup}
            <h4>${dash.titulo}</h4>
            <p>${dash.descricao}</p>
          `;
          card.addEventListener("click", () => selecionarPainel(dash.id));
          panelGrid.appendChild(card);
        });

        setActiveNav(theme.id);

        alternarView("panels");
      }

      function selecionarPainel(panelId) {
        if (!temaAtual) return;
        const panel = temaAtual.dashboards.find((item) => item.id === panelId);
        if (!panel) return;

        painelAtual = panel;
        setActiveNav(temaAtual.id, panel.id);

        const embedUrl = panel.embedUrl && String(panel.embedUrl).trim();

        if (embedUrl) {
          powerBIFrame.classList.remove("hidden");
          powerBIFrame.src = embedUrl;
          embedPlaceholder.classList.remove("active");
          embedPlaceholderTitle.textContent = "Power BI em breve";
          embedPlaceholderMessage.textContent = "Estamos preparando o link deste painel no Power BI. Tente novamente mais tarde.";
        } else {
          powerBIFrame.src = "";
          powerBIFrame.classList.add("hidden");
          embedPlaceholder.classList.add("active");
          embedPlaceholderTitle.textContent = "Power BI em breve";
          embedPlaceholderMessage.textContent = `O painel ${panel.titulo} ainda não possui link do Power BI. Assim que o embed estiver disponível, ele aparecerá automaticamente aqui.`;
        }

        alternarView("embed");
      }

      function alternarView(view) {
        viewAtual = view;
        Object.entries(views).forEach(([key, section]) => {
          section.classList.toggle("active", key === view);
        });
        atualizarLinkAjuda();
      }

      document.querySelectorAll('[data-action="go-home"]').forEach((button) => {
        button.addEventListener("click", (event) => {
          event.preventDefault();
          temaAtual = null;
          painelAtual = null;
          panelGrid.innerHTML = "";
          powerBIFrame.src = "";
          powerBIFrame.classList.remove("hidden");
          embedPlaceholder.classList.remove("active");
          embedPlaceholderTitle.textContent = "Power BI em breve";
          embedPlaceholderMessage.textContent = "Estamos preparando o link deste painel no Power BI. Tente novamente mais tarde.";
          setActiveNav(null);
          alternarView("themes");
          ajustarFonteMenu();
        });
      });

      window.addEventListener("resize", ajustarFonteMenu);

      atualizarLinkAjuda();
      ajustarFonteMenu();
      carregarMenu();
    </script>
  </body>
</html>
